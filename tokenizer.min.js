/**
 * Tag manager plugin for jQuery.
 * version 0.1.1
 * Kane Cohen [KaneCohen@gmail.com] | https://github.com/KaneCohen | https://github.com/KaneCohen/tokenizer
 * @preserve
 */
!function(factory){"function"==typeof define&&define.amd?define(["jquery"],factory):factory(jQuery)}(function($){function guid(){return(0|65536*(1+Math.random())).toString(16).substring(1)}function Tokenizer(o){this.id=guid(),this.o=$.extend(!0,{},this.d,o),this.v=$.extend(!0,{},defaultVars),this.init(o)}$.fn.tokenizer=function(options){var vals=[],o={},args=arguments;return"string"==$.type(options)?o=options:($.extend(o,options),o.elements=$(this.selector),o.selector=this.selector),this.each(function(){o.element=$(this);var tokenizer=$(this).parents(".tokenizer").data("tokenizer");tokenizer?(tokenizer.trigger.apply(tokenizer,args),vals.push(tokenizer.o.element)):new Tokenizer(o)}),1==vals.length?vals[0]:vals.length>1?vals:this};var defaultVars={keys:{8:"backspace",9:"tab",13:"enter",27:"escape",37:"left",38:"up",39:"right",40:"down",46:"delete",108:"numpadEnter"},wrapper:null,typehead:null,listWrapper:null,list:null,itemsList:null,activeItems:[],cache:{},timer:null,ajaxCall:null,setItems:[],classes:{wrapper:"tokenizer",typehead:"tokenizer-typehead",list:"tokenizer-list"},html:{wrapper:'<div class="tokenizer"/></div>',typehead:'<input class="tokenizer-typehead" />',listWrapper:'<div class="tokenizer-list-wrapper">',list:'<ul class="tokenizer-list"></ul>',listItem:'<li class="list-item"></li>',itemsWrapper:'<div class="tokenizer-items-wrapper"><ul class="items-list"></ul></div>',item:'<li class="item"><span class="item-label"></span><span class="item-remove">Ã—</span><input type="hidden" /></li>'}};Tokenizer.prototype={id:null,v:{},o:{},d:{element:null,items:[],newItems:!0,multiple:!0,ajaxType:"GET",url:!1,queryParam:"q",limit:!1,ajaxDelay:300,placeholder:!1,minChars:2,noSubmit:!0,start:null,listLength:8,itemName:"items",newItemSuffix:"New",itemProp:"id",newItemProp:"name",searchProperty:"name",callbacks:{itemAdd:function(){},itemBuild:function(){},itemRemove:function(){},parseItems:function(){},listShow:function(){},listBuild:function(){},listItemClick:function(){},ajaxBefore:function(){},ajaxAfter:function(){},error:function(){}}},init:function(){this.initHtml(),this.initEvents(),this.initCallbacks(),this.refreshInput();var tokenizers=$(document).data("tokenizers")||{};tokenizers[this.id]=this,$(document).data("tokenizers",tokenizers)},initHtml:function(){var self=this,o=this.o,v=this.v;o.element.wrap(v.html.wrapper),v.wrapper=o.element.parent(),v.wrapper.addClass(v.classes.wrapper),v.typehead=$(v.html.typehead),v.wrapper.append(v.typehead),o.placeholder===!1&&(o.placeholder=o.element.attr("placeholder")||""),v.typehead.attr("placeholder",o.placeholder),v.wrapper.css({width:o.element.width()}),v.itemsList=$(v.html.itemsWrapper),v.wrapper.prepend(v.itemsList),v.listWrapper=$(v.html.listWrapper).hide(),v.wrapper.append(v.listWrapper),o.element.hide(),o.element.data("tokenizer",this),v.wrapper.data("tokenizer",this),this.length(o.items)>0&&(v.activeItems=o.items instanceof Array?o.items:this.values(o.items),$.each(o.items,function(k,v){self.addItem(v.id)})),v.setItems.length>1&&v.typehead.removeAttr("placeholder")},initEvents:function(){var v=this.v;if(void 0==$(document).data("tokenizer")){$(document).data("tokenizer",!0);var wrapperClass="."+v.classes.wrapper;$(document).on("mousedown.tokenizer",function(e){if(!$(e.target).is(wrapperClass)&&!$(e.target).parents().is(wrapperClass)){var tokenizers=$(document).data("tokenizers")||{};$.each(tokenizers,function(k,tokenizer){tokenizer.destroyList()})}}),$(document).on("click.tokenizer",wrapperClass,function(e){var tokenizer=$(this).data("tokenizer");void 0!=tokenizer&&(tokenizer.mouseClick(e),e.stopPropagation())});var itemClass="."+v.classes.list+" li";$(document).on("mouseenter.tokenizer",itemClass,function(e){var tokenizer=$(this).parents(wrapperClass).data("tokenizer");void 0!=tokenizer&&tokenizer.mouseHover(e)}),$(document).on("mouseleave.tokenizer",itemClass,function(e){var tokenizer=$(this).parents(wrapperClass).data("tokenizer");void 0!=tokenizer&&tokenizer.mouseLeave(e)});var typeheadClass="."+v.classes.typehead;$(document).on("focusin.tokenizer",typeheadClass,function(e){var tokenizer=$(this).parents(wrapperClass).data("tokenizer");void 0!=tokenizer&&($(document).off("keydown.tokenizer"),$(document).on("keydown.tokenizer",typeheadClass,function(e){tokenizer.keyDown(e),e.stopPropagation()})),$(document).on("focusout.tokenizer",typeheadClass,function(e){$(document).off("keydown.tokenizer"),$(document).off("focusout.tokenizer"),e.stopPropagation()}),e.stopPropagation()})}},initCallbacks:function(){var self=this;$.each(this.o.callbacks,function(k){self.o.callbacks[k]=function(){var args=Array.prototype.slice.call(arguments);return self.o.element.triggerHandler(k,args)}})},bounds:function(){return this.v.wrapper[0].getBoundingClientRect()},keyDown:function(e){var self=this;setTimeout(function(){self.resizeInput(self.v.typehead.val())},1),void 0!=this.v.keys[e.keyCode]?this.keyAction(e):(clearTimeout(this.v.timer),null!==this.v.ajaxCall&&(this.v.ajaxCall.abort(),this.v.ajaxCall=null),setTimeout(function(){self.keyChar(e)},1))},keyChar:function(){var self=this,val=this.v.typehead.val();return val.length<this.o.minChars?(this.destroyList(),!1):1!=this.v.setItems.length||this.o.multiple?","==val[val.length-1]?(this.newItem(val.slice(0,val.length-1)),this.refreshInput(),!1):(void 0==this.v.cache[val]?this.o.url&&(this.v.timer=setTimeout(function(){self.loadData(val)},this.o.ajaxDelay)):(this.v.activeItems=this.v.cache[val],this.buildList(this.filterItems(this.v.cache[val]))),!1):(this.trigger("error"),!1)},keyAction:function(e){var self=this,keyName=this.v.keys[e.keyCode],val=$.trim(this.v.typehead.val()),id=!1;switch(this.v.list&&(id=this.v.list.find("li.selected").data("id")),keyName){case"esc":this.destroyList();break;case"up":this.selectPrevItem();break;case"down":this.selectNextItem();break;default:if("enter"==keyName||"numpadEnter"==keyName||"tab"==keyName)null!==this.v.ajaxCall&&(this.v.ajaxCall.abort(),this.v.ajaxCall=null),this.v.list?(this.addItem(id),this.refreshInput()):val.length>0&&(this.newItem(val),this.refreshInput()),this.v.activeItems=[],this.destroyList(),val.length>0&&e.preventDefault();else if("backspace"==keyName||"delete"==keyName){if(null!==this.v.ajaxCall&&(this.v.ajaxCall.abort(),this.v.ajaxCall=null),val.length<this.o.minChars){if(this.destroyList(),0===val.length&&this.v.setItems.length>0){var item=this.v.setItems[this.v.setItems.length-1];this.removeItem(item.id),this.v.typehead.change()}return}this.v.timer=setTimeout(function(){self.keyChar(e)},this.o.ajaxDelay)}}},selectPrevItem:function(){var list=this.v.list;if(list){var s=list.find("li.selected"),index=s.index();-1==index?list.find("li").last().addClass("selected"):-1!=index&&index>0?(s.removeClass("selected"),s.prev().addClass("selected")):0===index&&s.removeClass("selected")}},selectNextItem:function(){var list=this.v.list;if(list){var s=list.find("li.selected"),l=list.find("li").length,index=s.index();-1==index?list.find("li").first().addClass("selected"):-1!=index&&l-1>index?(s.removeClass("selected"),s.next().addClass("selected")):index==l-1&&s.removeClass("selected")}},mouseClick:function(e){var target=$(e.target);if(target.hasClass("item-remove"))this.removeItem(target.parents(".item").data("id"));else if(target.hasClass("list-item")){if(this.trigger("list-item-click",e)===!1)return;this.addItem(target.data("id")),this.destroyList(),this.refreshInput()}else this.v.typehead.focus(),this.keyChar()},mouseHover:function(e){this.v.wrapper.find("li.selected").removeClass("selected"),$(e.target).addClass("selected")},mouseLeave:function(e){0===$(e.target).data("key")&&$(e.target).removeClass("selected")},clearItems:function(){this.v.setItems=[],this.v.itemsList.empty()},destroyList:function(){this.v.list&&(this.v.listWrapper.hide().empty(),this.v.list=null)},buildList:function(items){var self=this,o=this.o,v=this.v,b=this.bounds();return newItems=this.trigger("parseItems",items,this),void 0!=newItems.length&&newItems.length>=0&&(items=newItems),0===items.length?!1:(v.list=$(v.html.list),$.each(items,function(k,v){if(k>=o.listLength)return!1;var el=self.trigger("listBuild");el===!0&&(el=$(self.v.html.listItem).attr("data-id",v.id).attr("data-key",k).attr("title",v[o.searchProperty]).html(v[o.searchProperty]),0===k&&el.addClass("selected")),self.v.list.append(el)}),v.listWrapper.html(v.list),v.listWrapper.addClass(this.v.classes.list).css({top:b.height}).show(),this.trigger("listShow"),void 0)},filterItems:function(items){var self=this;if(0===self.v.setItems.length)return items;var filteredItems=[];return $.each(items,function(k,v){$.each(self.v.setItems,function(i,t){return v.id==t.id?!1:(i==self.v.setItems.length-1&&filteredItems.push(v),void 0)})}),filteredItems},getItem:function(val,prop){void 0==prop&&(prop="id");var item=!1;return $.each(this.v.activeItems,function(k,v){if("id"==prop){if(v[prop]==val)return item=v,!1}else if(void 0!=v[prop]&&"string"==$.type(v[prop])&&v[prop].toLowerCase()==val.toLowerCase())return item=v,!1}),item},setItem:function(val){var item=this.getItem(val,this.o.searchProperty);if(!item&&void 0!=val){if(!this.o.newItems&&void 0==val.id)return!1;this.o.activeItems.push(val),this.addItem(val.id),this.refreshInput()}},newItem:function(val){var item=this.getItem(val,this.o.searchProperty);if(!item){if(!this.o.newItems)return!1;var id="new-"+guid();item={id:id,newItem:!0},item[this.o.searchProperty]=$.trim(val),this.v.activeItems.push(item)}return this.addItem(item.id),this.refreshInput(),!0},addItem:function(id){var o=this.o,v=this.v,itemEl=$(v.html.item),input=itemEl.find("input");if(1===v.setItems.length&&!o.multiple)return this.trigger("error"),!1;var item=this.getItem(id);if(item){if(this.trigger("itemAdd",item,this)===!1)return!1;itemEl.find(".item-label").text(item[o.searchProperty]).parent().attr("data-id",id),item.newItem?(input.attr("name",o.itemName+o.newItemSuffix+"[]"),input.val(item[o.newItemProp])):(input.attr("name",o.itemName+"[]"),input.val(item[o.itemProp])),this.trigger("itemBuild",item,itemEl,this),v.itemsList.append(itemEl),v.setItems.push(item);var inputArray=[];$.each(v.setItems,function(k,v){inputArray.push(v.name)}),this.o.element.val(inputArray.join(", "))}else this.o.newItems&&this.newItem(this.v.typehead.val());return!1},removeItem:function(id){var self=this;this.v.setItems.length>0&&$.each(this.v.setItems,function(k,v){return v.id==id?self.trigger("itemRemove",v)===!1?!1:(self.v.setItems.splice(k,1),self.v.itemsList.find('[data-id="'+id+'"]').remove(),self.v.typehead.change(),!1):void 0}),this.refreshInput()},getItems:function(){return this.v.setItems},refreshInput:function(focus){focus!==!1?this.v.typehead.val("").change().focus():this.v.typehead.val("").change(),this.resizeInput(""),this.v.setItems.length>0?this.v.typehead.attr("placeholder",null):this.v.typehead.attr("placeholder",this.o.placeholder)},resizeInput:function(val){var style=window.getComputedStyle(this.v.wrapper[0]),compensate=parseInt(style["padding-left"],10)+parseInt(style.paddingRight,10),b=this.bounds();if(0===$("#tokenizer-text-length").length){var textHolder=$(document.createElement("div")).attr("id","tokenizer-text-length").css({width:"auto",height:"auto",overflow:"hidden",whiteSpace:"pre",maxWidth:b.width-compensate,position:"fixed",top:-100,left:-1e3,fontSize:style.fontSize}).text(val);$("body").append(textHolder)}else $("#tokenizer-text-length").text(val);var w=$("#tokenizer-text-length").width();this.v.typehead[0].style.width="20px";var rw=b.width-this.v.typehead.position().left-parseInt(style.paddingLeft,10);this.v.typehead[0].style.width=w>rw?b.width-compensate+"px":rw+"px"},loadData:function(val){var self=this,o=this.o,v=this.v,inputData={};return inputData[o.queryParam]=val,inputData.timestamp=Math.round((new Date).getTime()/1e3),o.limit&&(inputData[o.limit]=o.limit),this.trigger("ajaxBefore")===!1?!1:(v.ajaxCall=$.ajax({url:o.url,type:o.ajaxType,data:inputData,dataType:"JSON"}).done(function(response){return self.trigger("ajaxAfter")===!1?!1:(self.v.activeItems=response,self.v.cache[val]=response,self.buildList(self.filterItems(response)),void 0)}),void 0)},destroy:function(){this.o.element.removeData("tokenizer");var el=this.o.element;o.wrapper.replaceWith(el),el.show();var tokenizers=$(document).data("tokenizers")||{};delete tokenizers[this.id],$(document).data("tokenizers",tokenizers)},values:function(object){return $.map(object,function(k){return k})},length:function(object){var size=0;if("object"!=typeof object)return void 0==object.length?0:object.length;for(key in object)object.hasOwnProperty(key)&&size++;return size},trigger:function(name){var args=Array.prototype.slice.call(arguments,1);if(void 0!=this.o.callbacks[name]){var call=this.o.callbacks[name].apply(this,args);return void 0===call?!0:call}return this[name]&&this[name].apply(this,args)===!1?!1:!0}}});